# TCP/IP 详解卷一：协议

---

# 第3章 IP：网际协议
- IP协议提供不可靠、无连接的数据报传送服务
    - 不可靠(unreliable): 不保证IP数据报成功抵达目的地
    - 无连接(connectionless): 不维护任何关于后续数据报的状态信息，每个数据报的处理相互独立
## IP header
- IP首部长度20B（不含选项字段）
- IP首部中的二进制整数的传输次序为big endian

## IP路由选择
- 若目的主机与源主机直接相连（如点对点连接）或在一个共享网络上（以太网(ethernet)或令牌环网），则IP数据报直接发送到目标主机，否则发往路由器，由路由器转发数据报
- IP层既可以配置为路由器功能，也可以配置为主机功能
    - 主机和路由的区别是是否转发数据报
    - IP层可以接收本地生成的数据报并发送，或从网络接口接收待转发的数据报并发送
- IP层在内存中有一个路由表，每次接收到数据报时搜索路由表
    - 若数据报来自某个网络接口，IP检查目的IP地址是否为本机IP地址之一或IP广播地址
        - 是：数据报被送到有IP首部协议字段指定的协议模块处理
        - 否：若IP层被设置为路由器功能，则转发数据报，否则丢弃数据报
    - 若数据报来自本地协议模块，则转发数据报
- 路由表每一项的内容
    - 目的IP地址：网络地址或完整的主机地址
    - 下一跳路由器IP地址或直接连接的网络IP地址
    - 标志：指明目的IP地址是主机地址还是网络地址，下一跳路由器是真正的路由器还是直接相连的接口
    - 为数据报传输指定一个网络接口
- IP路由选择逐跳进行(hop-by-hop)，IP不知道完整路径，IP路由选择只为数据报传输提供下一跳路由的IP地址（假定下一跳路由器比发送数据报的主机更接近目的，且下一跳路由器与该主机直接相连）
- IP路由选择的功能
    - 搜索路由表，寻找与目的IP地址完全匹配的表目（网络号和主机号匹配），若找到则发送报文给该表目指定的下一跳路由器或直接相连的网络接口
    - 搜索路由表，寻找与目的网络号匹配的表目，若找到，则发送报文……（同上），目的网络上的所有主机均通过该表目处理（以太网的路由选择方式）
    - 搜索路由表，寻找"default"表目，若找到，则发送报文给该表目指定的下一站路由器（默认路由）
    - 若上述步骤均未成功，则该数据报不能发送
- 为一个网络指定一个路由器，而不必为一个主机指定一个路由器，可以极大缩小路由表规模
- IP首部中的目的IP地址是最终IP地址，链路层首部中的目的IP地址是下一跳路由地址

## 子网寻址
- 子网编址：IP地址 = 网络号 + 子网号 + 主机号
    - A类和B类地址为主机号分配了太多空间，将主机号细分为子网号和主机号
- 子网对外部路由器隐藏内部网络的细节，缩减路由表规模
- 子网对于子网外部路由器透明，对于子网内部路由器不透明

## 子网掩码
- 主机引导时配置IP地址，需要知道子网号长度和主机号长度 ==> 子网掩码
- 子网掩码是32 bit的值，值为1的比特位表示网络号和子网号，值为0的比特位表示主机号
- 给定IP地址和子网掩码后，主机可以确定IP数据报的目的
    - 本子网中的主机
    - 本网络中其他子网中的主机
    - 其他网络中的主机
    - 从本机IP地址的高位可以区分ABC类地址，从而区分网络号和子网号

